"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const electron_1 = require("electron");
const stream_1 = require("stream");
const isRenderer = process.type === 'renderer';
const getSenderId = (e) => typeof e.senderId === 'number' ? e.senderId :
    typeof e.sender.id === 'number' ? e.sender.id : 0;
const getFullChannel = (channel, webContentsId) => `sei-${channel}-${webContentsId}`;
class ElectronIpcMainDuplex extends stream_1.Duplex {
    constructor(webContents, channel = 'data') {
        super();
        this.webContents = webContents;
        this.wcId = webContents.id;
        this.channel = getFullChannel(channel, 0);
        webContents.once('close', () => {
            this.end();
        });
        webContents.once('destroyed', () => {
            this.destroy();
        });
        electron_1.ipcMain.on(getFullChannel(channel, this.wcId), (_, data) => {
            this.push(data);
        });
        // init connection
        this.webContents.send(channel);
    }
    // tslint:disable-next-line
    _write(chunk, _encoding, callback) {
        this.webContents.send(this.channel, new Uint8Array(chunk));
        callback();
    }
    // tslint:disable-next-line
    _read(_size) { }
}
exports.ElectronIpcMainDuplex = ElectronIpcMainDuplex;
class ElectronIpcRendererDuplex extends stream_1.Duplex {
    constructor(webContentsId, channel = 'data') {
        super();
        this.wcId = typeof webContentsId === 'number' ? webContentsId : 0;
        this.channel = getFullChannel(channel, electron_1.remote.getCurrentWebContents().id);
        if (this.wcId === 0) {
            // renderer to main
            this.sendTo = electron_1.ipcRenderer.send.bind(electron_1.ipcRenderer);
        }
        else {
            // renderer to renderer
            this.sendTo = electron_1.ipcRenderer.sendTo.bind(electron_1.ipcRenderer, this.wcId);
        }
        electron_1.ipcRenderer.on(getFullChannel(channel, this.wcId), (_, data) => {
            this.push(data);
        });
        // init connection
        this.sendTo(channel);
    }
    // tslint:disable-next-line
    _write(chunk, _encoding, callback) {
        this.sendTo(this.channel, new Uint8Array(chunk));
        callback();
    }
    // tslint:disable-next-line
    _read(_size) { }
}
exports.ElectronIpcRendererDuplex = ElectronIpcRendererDuplex;
exports.firstConnectionHandler = (callback, channel) => {
    const seensIds = new Set();
    (isRenderer ? electron_1.ipcRenderer : electron_1.ipcMain).on(channel || 'data', (e, data) => {
        const senderId = getSenderId(e);
        if (!channel) { // default channel is 'data', and we just listen for first bytes received, not a particular event
            if (seensIds.has(senderId))
                return;
            seensIds.add(senderId);
        }
        let duplex;
        if (isRenderer) {
            duplex = new ElectronIpcRendererDuplex(senderId, channel || 'data');
        }
        else {
            duplex = new ElectronIpcMainDuplex(e.sender, channel || 'data');
        }
        if (!channel) {
            duplex.push(data);
        }
        callback(duplex);
    });
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSx1Q0FBd0Q7QUFDeEQsbUNBQWdDO0FBRWhDLE1BQU0sVUFBVSxHQUFHLE9BQU8sQ0FBQyxJQUFJLEtBQUssVUFBVSxDQUFDO0FBQy9DLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBTSxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0UsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDcEQsTUFBTSxjQUFjLEdBQUcsQ0FBQyxPQUFlLEVBQUUsYUFBcUIsRUFBRSxFQUFFLENBQUMsT0FBTyxPQUFPLElBQUksYUFBYSxFQUFFLENBQUM7QUFFckcsTUFBYSxxQkFBc0IsU0FBUSxlQUFNO0lBSy9DLFlBQVksV0FBaUMsRUFBRSxVQUFrQixNQUFNO1FBQ3JFLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLElBQUksR0FBRyxXQUFXLENBQUMsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQztRQUMxQyxXQUFXLENBQUMsSUFBSSxDQUFDLE9BQWMsRUFBRSxHQUFHLEVBQUU7WUFDcEMsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ2IsQ0FBQyxDQUFDLENBQUM7UUFDSCxXQUFXLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxHQUFHLEVBQUU7WUFDakMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2pCLENBQUMs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QkFBRSxPQUFPO1lBQ25DLFFBQVEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDeEI7UUFDRCxJQUFJLE1BQWMsQ0FBQztRQUNuQixJQUFJLFVBQVUsRUFBRTtZQUNkLE1BQU0sR0FBRyxJQUFJLHlCQUF5QixDQUFDLFFBQVEsRUFBRSxPQUFPLElBQUksTUFBTSxDQUFDLENBQUM7U0FDckU7YUFBTTtZQUNMLE1BQU0sR0FBRyxJQUFJLHFCQUFxQixDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxJQUFJLE1BQU0sQ0FBQyxDQUFDO1NBQ2pFO1FBQ0QsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDbkI7UUFDRCxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDbkIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpcGNNYWluLCBpcGNSZW5kZXJlciwgcmVtb3RlIH0gZnJvbSAnZWxlY3Ryb24nO1xyXG5pbXBvcnQgeyBEdXBsZXggfSBmcm9tICdzdHJlYW0nO1xyXG5cclxuY29uc3QgaXNSZW5kZXJlciA9IHByb2Nlc3MudHlwZSA9PT0gJ3JlbmRlcmVyJztcclxuY29uc3QgZ2V0U2VuZGVySWQgPSAoZTogYW55KSA9PiB0eXBlb2YgZS5zZW5kZXJJZCA9PT0gJ251bWJlcicgPyBlLnNlbmRlcklkIDpcclxuICB0eXBlb2YgZS5zZW5kZXIuaWQgPT09ICdudW1iZXInID8gZS5zZW5kZXIuaWQgOiAwO1xyXG5jb25zdCBnZXRGdWxsQ2hhbm5lbCA9IChjaGFubmVsOiBzdHJpbmcsIHdlYkNvbnRlbnRzSWQ6IG51bWJlcikgPT4gYHNlaS0ke2NoYW5uZWx9LSR7d2ViQ29udGVudHNJZH1gO1xyXG5cclxuZXhwb3J0IGNsYXNzIEVsZWN0cm9uSXBjTWFpbkR1cGxleCBleHRlbmRzIER1cGxleCB7XHJcbiAgd2ViQ29udGVudHM6IEVsZWN0cm9uLldlYkNvbnRlbnRzO1xyXG4gIHdjSWQ6IG51bWJlcjtcclxuICBjaGFubmVsOiBzdHJpbmc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHdlYkNvbnRlbnRzOiBFbGVjdHJvbi5XZWJDb250ZW50cywgY2hhbm5lbDogc3RyaW5nID0gJ2RhdGEnKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgdGhpcy53ZWJDb250ZW50cyA9IHdlYkNvbnRlbnRzO1xyXG4gICAgdGhpcy53Y0lkID0gd2ViQ29udGVudHMuaWQ7XHJcbiAgICB0aGlzLmNoYW5uZWwgPSBnZXRGdWxsQ2hhbm5lbChjaGFubmVsLCAwKTtcclxuICAgIHdlYkNvbnRlbnRzLm9uY2UoJ2Nsb3NlJyBhcyBhbnksICgpID0+IHtcclxuICAgICAgdGhpcy5lbmQoKTtcclxuICAgIH0pO1xyXG4gICAgd2ViQ29udGVudHMub25jZSgnZGVzdHJveWVkJywgKCkgPT4ge1xyXG4gICAgICB0aGlzLmRlc3Ryb3koKTtcclxuICAgIH0pO1xyXG4gICAgaXBjTWFpbi5vbihnZXRGdWxsQ2hhbm5lbChjaGFubmVsLCB0aGlzLndjSWQpLCAoXzogYW55LCBkYXRhOiBVaW50OEFycmF5KSA9PiB7XHJcbiAgICAgIHRoaXMucHVzaChkYXRhKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGluaXQgY29ubmVjdGlvblxyXG4gICAgdGhpcy53ZWJDb250ZW50cy5zZW5kKGNoYW5uZWwpO1xyXG4gIH1cclxuXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXHJcbiAgX3dyaXRlKGNodW5rOiBCdWZmZXIsIF9lbmNvZGluZzogYW55LCBjYWxsYmFjazogRnVuY3Rpb24pIHtcclxuICAgIHRoaXMud2ViQ29udGVudHMuc2VuZCh0aGlzLmNoYW5uZWwsIG5ldyBVaW50OEFycmF5KGNodW5rKSk7XHJcbiAgICBjYWxsYmFjaygpO1xyXG4gIH1cclxuXHJcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lXHJcbiAgX3JlYWQoX3NpemU6IGFueSkge31cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIEVsZWN0cm9uSXBjUmVuZGVyZXJEdXBsZXggZXh0ZW5kcyBEdXBsZXgge1xyXG4gIHdjSWQ6IG51bWJlcjtcclxuICBzZW5kVG86IChjaGFubmVsOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkO1xyXG4gIGNoYW5uZWw6IHN0cmluZztcclxuXHJcbiAgY29uc3RydWN0b3Iod2ViQ29udGVudHNJZD86IG51bWJlciwgY2hhbm5lbDogc3RyaW5nID0gJ2RhdGEnKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgdGhpcy53Y0lkID0gdHlwZW9mIHdlYkNvbnRlbnRzSWQgPT09ICdudW1iZXInID8gd2ViQ29udGVudHNJZCA6IDA7XHJcbiAgICB0aGlzLmNoYW5uZWwgPSBnZXRGdWxsQ2hhbm5lbChjaGFubmVsLCByZW1vdGUuZ2V0Q3VycmVudFdlYkNvbnRlbnRzKCkuaWQpO1xyXG4gICAgaWYgKHRoaXMud2NJZCA9PT0gMCkge1xyXG4gICAgICAvLyByZW5kZXJlciB0byBtYWluXHJcbiAgICAgIHRoaXMuc2VuZFRvID0gaXBjUmVuZGVyZXIuc2VuZC5iaW5kKGlwY1JlbmRlcmVyKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vIHJlbmRlcmVyIHRvIHJlbmRlcmVyXHJcbiAgICAgIHRoaXMuc2VuZFRvID0gaXBjUmVuZGVyZXIuc2VuZFRvLmJpbmQoaXBjUmVuZGVyZXIsIHRoaXMud2NJZCk7XHJcbiAgICB9XHJcbiAgICBpcGNSZW5kZXJlci5vbihnZXRGdWxsQ2hhbm5lbChjaGFubmVsLCB0aGlzLndjSWQpLCAoXzogYW55LCBkYXRhOiBVaW50OEFycmF5KSA9PiB7XHJcbiAgICAgIHRoaXMucHVzaChkYXRhKTtcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIGluaXQgY29ubmVjdGlvblxyXG4gICAgdGhpcy5zZW5kVG8oY2hhbm5lbCk7XHJcbiAgfVxyXG5cclxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmVcclxuICBfd3JpdGUoY2h1bms6IEJ1ZmZlciwgX2VuY29kaW5nOiBhbnksIGNhbGxiYWNrOiBGdW5jdGlvbikge1xyXG4gICAgdGhpcy5zZW5kVG8odGhpcy5jaGFubmVsLCBuZXcgVWludDhBcnJheShjaHVuaykpO1xyXG4gICAgY2FsbGJhY2soKTtcclxuICB9XHJcblxyXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZVxyXG4gIF9yZWFkKF9zaXplOiBhbnkpIHt9XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBmaXJzdENvbm5lY3Rpb25IYW5kbGVyID0gKGNhbGxiYWNrOiAoc29ja2V0OiBEdXBsZXgpID0+IHZvaWQsIGNoYW5uZWw/OiBzdHJpbmcpID0+IHtcclxuICBjb25zdCBzZWVuc0lkcyA9IG5ldyBTZXQ8bnVtYmVyPigpO1xyXG4gIChpc1JlbmRlcmVyID8gaXBjUmVuZGVyZXIgOiBpcGNNYWluKS5vbihjaGFubmVsIHx8ICdkYXRhJywgKGU6IGFueSwgZGF0YTogYW55KSA9PiB7XHJcbiAgICBjb25zdCBzZW5kZXJJZCA9IGdldFNlbmRlcklkKGUpO1xyXG4gICAgaWYgKCFjaGFubmVsKSB7IC8vIGRlZmF1bHQgY2hhbm5lbCBpcyAnZGF0YScsIGFuZCB3ZSBqdXN0IGxpc3RlbiBmb3IgZmlyc3QgYnl0ZXMgcmVjZWl2ZWQsIG5vdCBhIHBhcnRpY3VsYXIgZXZlbnRcclxuICAgICAgaWYgKHNlZW5zSWRzLmhhcyhzZW5kZXJJZCkpIHJldHVybjtcclxuICAgICAgc2VlbnNJZHMuYWRkKHNlbmRlcklkKTtcclxuICAgIH1cclxuICAgIGxldCBkdXBsZXg6IER1cGxleDtcclxuICAgIGlmIChpc1JlbmRlcmVyKSB7XHJcbiAgICAgIGR1cGxleCA9IG5ldyBFbGVjdHJvbklwY1JlbmRlcmVyRHVwbGV4KHNlbmRlcklkLCBjaGFubmVsIHx8ICdkYXRhJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBkdXBsZXggPSBuZXcgRWxlY3Ryb25JcGNNYWluRHVwbGV4KGUuc2VuZGVyLCBjaGFubmVsIHx8ICdkYXRhJyk7XHJcbiAgICB9XHJcbiAgICBpZiAoIWNoYW5uZWwpIHtcclxuICAgICAgZHVwbGV4LnB1c2goZGF0YSk7XHJcbiAgICB9XHJcbiAgICBjYWxsYmFjayhkdXBsZXgpO1xyXG4gIH0pO1xyXG59O1xyXG4iXX0=