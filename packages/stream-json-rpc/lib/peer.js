"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const json_rpc_peer_1 = require("@magne4000/json-rpc-peer");
const errors_1 = require("./errors");
const uuidv4 = require('uuid/v4');
const callMethod = (fn, args) => {
    return new Promise((resolve) => {
        resolve(fn(args));
    });
};
const withTimeout = (fn, args, timeout, methodName, forwardErrors) => new Promise((resolve, reject) => {
    callMethod(fn, args)
        .then(resolve)
        .catch(e => {
        const error = e instanceof Error ? e : new Error(`${methodName} ${e}`);
        if (forwardErrors && typeof error.toJsonRpcError !== 'function') {
            error.toJsonRpcError = () => ({
                code: 1,
                message: error.message,
                data: {
                    stack: error.stack,
                },
            });
        }
        reject(error);
    });
    if (timeout > 0) {
        setTimeout(reject, timeout, new json_rpc_peer_1.JsonRpcError(`${methodName} timeout`));
    }
});
const peerCallback = (requestHandlers, notificationHandlers, options) => (message) => {
    switch (message.type) {
        case 'request': {
            if (!requestHandlers.has(message.method)) {
                throw new json_rpc_peer_1.JsonRpcError(`Method ${message.method} does not exists`);
            }
            const { timeout, handler } = requestHandlers.get(message.method);
            return withTimeout(handler, message.params, timeout, message.method, options.forwardErrors);
        }
        case 'notification': {
            if (!notificationHandlers.has(message.method)) {
                throw new json_rpc_peer_1.JsonRpcError(`Method ${message.method} does not exists`);
            }
            const handler = notificationHandlers.get(message.method);
            return handler(message.params);
        }
    }
};
class RPCPeer extends json_rpc_peer_1.default {
    constructor(options = {}) {
        const requestHandlers = new Map();
        const notificationHandlers = new Map();
        super(peerCallback(requestHandlers, notificationHandlers, options));
        this.id = uuidv4();
        this.requestHandlers = requestHandlers;
        this.notificationHandlers = notificationHandlers;
        this.defaultTimeout = options.defaultRequestTimeout === undefined ? 5000 : options.defaultRequestTimeout;
        this.closed = false;
        this.once('end', () => {
            this.closed = true;
        });
    }
    setRequestHandler(method, handler, timeout = this.defaultTimeout) {
        if (this.requestHandlers.has(method)) {
            throw new Error(`Method ${method} already handled`);
        }
        this.requestHandlers.set(method, {
            timeout,
            handler,
        });
        // Unsubscribe callback
        return () => {
            this.requestHandlers.delete(method);
        };
    }
    setNotificationHandler(method, handler) {
        if (this.notificationHandlers.has(method)) {
            throw new Error(`Method ${method} already handled`);
        }
        this.notificationHandlers.set(method, handler);
        // Unsubscribe callback
        return () => {
            this.notificationHandlers.delete(method);
        };
    }
    request(method, params) {
        return new Promise((resolve, reject) => {
            super.request(method, params)
                .then(resolve)
                .catch((e) => {
                reject(errors_1.wrapError(e));
            });
        });
    }
    destroy(error) {
        this.emit('close');
        this.emit('end');
        if (error) {
            this.emit('error', error);
        }
    }
}
exports.default = RPCPeer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9wZWVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsNERBQW1HO0FBQ25HLHFDQUFxQztBQUdyQyxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFbEMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxFQUFZLEVBQUUsSUFBUyxFQUFFLEVBQUU7SUFDN0MsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxFQUFFO1FBQzdCLE9BQU8sQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNwQixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQztBQUVGLE1BQU0sV0FBVyxHQUFHLENBQUMsRUFBWSxFQUFFLElBQVMsRUFBRSxPQUFlLEVBQUUsVUFBa0IsRUFBRSxhQUF1QixFQUFFLEVBQUUsQ0FDNUcsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7SUFDOUIsVUFBVSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUM7U0FDakIsSUFBSSxDQUFDLE9BQU8sQ0FBQztTQUNiLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUNULE1BQU0sS0FBSyxHQUFRLENBQUMsWUFBWSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxVQUFVLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1RSxJQUFJLGFBQWEsSUFBSSxPQUFPLEtBQUssQ0FBQyxjQUFjLEtBQUssVUFBVSxFQUFFO1lBQy9ELEtBQUssQ0FBQyxjQUFjLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQztnQkFDNUIsSUFBSSxFQUFFLENBQUM7Z0JBQ1AsT0FBTyxFQUFFLEtBQUssQ0FBQyxPQUFPO2dCQUN0QixJQUFJLEVBQUU7b0JBQ0osS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO2lCQUNuQjthQUNGLENBQUMsQ0FBQztTQUNKO1FBQ0QsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsSUFBSSxPQUFPLEdBQUcsQ0FBQyxFQUFFO1FBQ2YsVUFBVSxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSw0QkFBWSxDQUFDLEdBQUcsVUFBVSxVQUFVLENBQUMsQ0FBQyxDQUFDO0tBQ3hFO0FBQ0gsQ0FBQyxDQUFDLENBQUM7QUFFTCxNQUFNLFlBQVksR0FBRyxDQUNuQixlQUE0QyxFQUM1QyxvQkFBc0QsRUFDdEQsT0FBMEIsRUFBRSxFQUFFLENBQzlCLENBQUMsT0FBdUIsRUFBRSxFQUFFO0lBQzFCLFFBQVEsT0FBTyxDQUFDLElBQUksRUFBRTtRQUNwQixLQUFLLFNBQVMsQ0FBQyxDQUFDO1lBQ2QsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUN4QyxNQUFNLElBQUksNEJBQVksQ0FBQyxVQUFVLE9BQU8sQ0FBQyxNQUFNLGtCQUFrQixDQUFDLENBQUM7YUFDcEU7WUFDRCxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBRSxDQUFDO1lBQ2xFLE9BQU8sV0FBVyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUM3RjtRQUNELEtBQUssY0FBYyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQzdDLE1BQU0sSUFBSSw0QkFBWSxDQUFDLFVBQVUsT0FBTyxDQUFDLE1BQU0sa0JBQWtCLENBQUMsQ0FBQzthQUNwRTtZQUNELE1BQU0sT0FBTyxHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFFLENBQUM7WUFDMUQsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2hDO0tBQ0Y7QUFDSCxDQUFDLENBQUM7QUFRSixNQUFxQixPQUFRLFNBQVEsdUJBQUk7SUFPdkMsWUFBWSxVQUE2QixFQUFFO1FBQ3pDLE1BQU0sZUFBZSxHQUFHLElBQUksR0FBRyxFQUEwQixDQUFDO1FBQzFELE1BQU0sb0JBQW9CLEdBQUcsSUFBSSxHQUFHLEVBQStCLENBQUM7UUFDcEUsS0FBSyxDQUFDLFlBQVksQ0FBQyxlQUFlLEVBQUUsb0JBQW9CLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDO1FBQ25CLElBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO1FBRXZDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxvQkFBb0IsQ0FBQztRQUNqRCxJQUFJLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLHFCQUFxQixDQUFDO1FBQ3pHLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO1FBRXBCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEdBQUcsRUFBRTtZQUNwQixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxpQkFBaUIsQ0FBQyxNQUFjLEVBQUUsT0FBNkIsRUFBRSxVQUFrQixJQUFJLENBQUMsY0FBYztRQUNwRyxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3BDLE1BQU0sSUFBSSxLQUFLLENBQUMsVUFBVSxNQUFNLGtCQUFrQixDQUFDLENBQUM7U0FDckQ7UUFDRCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUU7WUFDL0IsT0FBTztZQUNQLE9BQU87U0FDUixDQUFDLENBQUM7UUFFSCx1QkFBdUI7UUFDdkIsT0FBTyxHQUFHLEVBQUU7WUFDVixJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN0QyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsc0JBQXNCLENBQUMsTUFBYyxFQUFFLE9BQThCO1FBQ25FLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN6QyxNQUFNLElBQUksS0FBSyxDQUFDLFVBQVUsTUFBTSxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3JEO1FBQ0QsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFFL0MsdUJBQXVCO1FBQ3ZCLE9BQU8sR0FBRyxFQUFFO1lBQ1YsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsT0FBTyxDQUFDLE1BQWMsRUFBRSxNQUE0QjtRQUNsRCxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3JDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztpQkFDMUIsSUFBSSxDQUFDLE9BQU8sQ0FBQztpQkFDYixLQUFLLENBQUMsQ0FBQyxDQUFlLEVBQUUsRUFBRTtnQkFDekIsTUFBTSxDQUFDLGtCQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN2QixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELE9BQU8sQ0FBQyxLQUFhO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqQixJQUFJLEtBQUssRUFBRTtZQUNULElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQzNCO0lBQ0gsQ0FBQztDQUNGO0FBbkVELDBCQW1FQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQZWVyLCB7IEpzb25ScGNFcnJvciwgSnNvblJwY1BhcmFtc1NjaGVtYSwgSnNvblJwY1BheWxvYWQgfSBmcm9tICdAbWFnbmU0MDAwL2pzb24tcnBjLXBlZXInO1xyXG5pbXBvcnQgeyB3cmFwRXJyb3IgfSBmcm9tICcuL2Vycm9ycyc7XHJcbmltcG9ydCB7IFJQQ0NoYW5uZWxPcHRpb25zLCBSUENDaGFubmVsUGVlciB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuY29uc3QgdXVpZHY0ID0gcmVxdWlyZSgndXVpZC92NCcpO1xyXG5cclxuY29uc3QgY2FsbE1ldGhvZCA9IChmbjogRnVuY3Rpb24sIGFyZ3M6IGFueSkgPT4ge1xyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xyXG4gICAgcmVzb2x2ZShmbihhcmdzKSk7XHJcbiAgfSk7XHJcbn07XHJcblxyXG5jb25zdCB3aXRoVGltZW91dCA9IChmbjogRnVuY3Rpb24sIGFyZ3M6IGFueSwgdGltZW91dDogbnVtYmVyLCBtZXRob2ROYW1lOiBzdHJpbmcsIGZvcndhcmRFcnJvcnM/OiBib29sZWFuKSA9PlxyXG4gIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIGNhbGxNZXRob2QoZm4sIGFyZ3MpXHJcbiAgICAgIC50aGVuKHJlc29sdmUpXHJcbiAgICAgIC5jYXRjaChlID0+IHtcclxuICAgICAgICBjb25zdCBlcnJvcjogYW55ID0gZSBpbnN0YW5jZW9mIEVycm9yID8gZSA6IG5ldyBFcnJvcihgJHttZXRob2ROYW1lfSAke2V9YCk7XHJcbiAgICAgICAgaWYgKGZvcndhcmRFcnJvcnMgJiYgdHlwZW9mIGVycm9yLnRvSnNvblJwY0Vycm9yICE9PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICBlcnJvci50b0pzb25ScGNFcnJvciA9ICgpID0+ICh7XHJcbiAgICAgICAgICAgIGNvZGU6IDEsXHJcbiAgICAgICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICBzdGFjazogZXJyb3Iuc3RhY2ssXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgfSk7XHJcbiAgICBpZiAodGltZW91dCA+IDApIHtcclxuICAgICAgc2V0VGltZW91dChyZWplY3QsIHRpbWVvdXQsIG5ldyBKc29uUnBjRXJyb3IoYCR7bWV0aG9kTmFtZX0gdGltZW91dGApKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbmNvbnN0IHBlZXJDYWxsYmFjayA9IChcclxuICByZXF1ZXN0SGFuZGxlcnM6IE1hcDxzdHJpbmcsIFJlcXVlc3RIYW5kbGVyPixcclxuICBub3RpZmljYXRpb25IYW5kbGVyczogTWFwPHN0cmluZywgTm90aWZpY2F0aW9uSGFuZGxlcj4sXHJcbiAgb3B0aW9uczogUlBDQ2hhbm5lbE9wdGlvbnMpID0+XHJcbiAgKG1lc3NhZ2U6IEpzb25ScGNQYXlsb2FkKSA9PiB7XHJcbiAgICBzd2l0Y2ggKG1lc3NhZ2UudHlwZSkge1xyXG4gICAgICBjYXNlICdyZXF1ZXN0Jzoge1xyXG4gICAgICAgIGlmICghcmVxdWVzdEhhbmRsZXJzLmhhcyhtZXNzYWdlLm1ldGhvZCkpIHtcclxuICAgICAgICAgIHRocm93IG5ldyBKc29uUnBjRXJyb3IoYE1ldGhvZCAke21lc3NhZ2UubWV0aG9kfSBkb2VzIG5vdCBleGlzdHNgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgeyB0aW1lb3V0LCBoYW5kbGVyIH0gPSByZXF1ZXN0SGFuZGxlcnMuZ2V0KG1lc3NhZ2UubWV0aG9kKSE7XHJcbiAgICAgICAgcmV0dXJuIHdpdGhUaW1lb3V0KGhhbmRsZXIsIG1lc3NhZ2UucGFyYW1zLCB0aW1lb3V0LCBtZXNzYWdlLm1ldGhvZCwgb3B0aW9ucy5mb3J3YXJkRXJyb3JzKTtcclxuICAgICAgfVxyXG4gICAgICBjYXNlICdub3RpZmljYXRpb24nOiB7XHJcbiAgICAgICAgaWYgKCFub3RpZmljYXRpb25IYW5kbGVycy5oYXMobWVzc2FnZS5tZXRob2QpKSB7XHJcbiAgICAgICAgICB0aHJvdyBuZXcgSnNvblJwY0Vycm9yKGBNZXRob2QgJHttZXNzYWdlLm1ldGhvZH0gZG9lcyBub3QgZXhpc3RzYCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGhhbmRsZXIgPSBub3RpZmljYXRpb25IYW5kbGVycy5nZXQobWVzc2FnZS5tZXRob2QpITtcclxuICAgICAgICByZXR1cm4gaGFuZGxlcihtZXNzYWdlLnBhcmFtcyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9O1xyXG5cclxudHlwZSBSZXF1ZXN0SGFuZGxlciA9IHtcclxuICB0aW1lb3V0OiBudW1iZXIsXHJcbiAgaGFuZGxlcjogKHBhcmFtczogYW55KSA9PiBhbnksXHJcbn07XHJcbnR5cGUgTm90aWZpY2F0aW9uSGFuZGxlciA9IChwYXJhbXM6IGFueSkgPT4gdm9pZDtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFJQQ1BlZXIgZXh0ZW5kcyBQZWVyIGltcGxlbWVudHMgUlBDQ2hhbm5lbFBlZXIge1xyXG4gIHB1YmxpYyBjbG9zZWQ6IGJvb2xlYW47XHJcbiAgcHVibGljIGlkOiBzdHJpbmc7XHJcbiAgcHJvdGVjdGVkIHJlcXVlc3RIYW5kbGVyczogTWFwPHN0cmluZywgUmVxdWVzdEhhbmRsZXI+O1xyXG4gIHByb3RlY3RlZCBub3RpZmljYXRpb25IYW5kbGVyczogTWFwPHN0cmluZywgTm90aWZpY2F0aW9uSGFuZGxlcj47XHJcbiAgcHJvdGVjdGVkIGRlZmF1bHRUaW1lb3V0OiBudW1iZXI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFJQQ0NoYW5uZWxPcHRpb25zID0ge30pIHtcclxuICAgIGNvbnN0IHJlcXVlc3RIYW5kbGVycyA9IG5ldyBNYXA8c3RyaW5nLCBSZXF1ZXN0SGFuZGxlcj4oKTtcclxuICAgIGNvbnN0IG5vdGlmaWNhdGlvbkhhbmRsZXJzID0gbmV3IE1hcDxzdHJpbmcsIE5vdGlmaWNhdGlvbkhhbmRsZXI+KCk7XHJcbiAgICBzdXBlcihwZWVyQ2FsbGJhY2socmVxdWVzdEhhbmRsZXJzLCBub3RpZmljYXRpb25IYW5kbGVycywgb3B0aW9ucykpO1xyXG4gICAgdGhpcy5pZCA9IHV1aWR2NCgpO1xyXG4gICAgdGhpcy5yZXF1ZXN0SGFuZGxlcnMgPSByZXF1ZXN0SGFuZGxlcnM7XHJcblxyXG4gICAgdGhpcy5ub3RpZmljYXRpb25IYW5kbGVycyA9IG5vdGlmaWNhdGlvbkhhbmRsZXJzO1xyXG4gICAgdGhpcy5kZWZhdWx0VGltZW91dCA9IG9wdGlvbnMuZGVmYXVsdFJlcXVlc3RUaW1lb3V0ID09PSB1bmRlZmluZWQgPyA1MDAwIDogb3B0aW9ucy5kZWZhdWx0UmVxdWVzdFRpbWVvdXQ7XHJcbiAgICB0aGlzLmNsb3NlZCA9IGZhbHNlO1xyXG5cclxuICAgIHRoaXMub25jZSgnZW5kJywgKCkgPT4ge1xyXG4gICAgICB0aGlzLmNsb3NlZCA9IHRydWU7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHNldFJlcXVlc3RIYW5kbGVyKG1ldGhvZDogc3RyaW5nLCBoYW5kbGVyOiAocGFyYW1zOiBhbnkpID0+IGFueSwgdGltZW91dDogbnVtYmVyID0gdGhpcy5kZWZhdWx0VGltZW91dCkge1xyXG4gICAgaWYgKHRoaXMucmVxdWVzdEhhbmRsZXJzLmhhcyhtZXRob2QpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWV0aG9kICR7bWV0aG9kfSBhbHJlYWR5IGhhbmRsZWRgKTtcclxuICAgIH1cclxuICAgIHRoaXMucmVxdWVzdEhhbmRsZXJzLnNldChtZXRob2QsIHtcclxuICAgICAgdGltZW91dCxcclxuICAgICAgaGFuZGxlcixcclxuICAgIH0pO1xyXG5cclxuICAgIC8vIFVuc3Vic2NyaWJlIGNhbGxiYWNrXHJcbiAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICB0aGlzLnJlcXVlc3RIYW5kbGVycy5kZWxldGUobWV0aG9kKTtcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBzZXROb3RpZmljYXRpb25IYW5kbGVyKG1ldGhvZDogc3RyaW5nLCBoYW5kbGVyOiAocGFyYW1zOiBhbnkpID0+IHZvaWQpIHtcclxuICAgIGlmICh0aGlzLm5vdGlmaWNhdGlvbkhhbmRsZXJzLmhhcyhtZXRob2QpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTWV0aG9kICR7bWV0aG9kfSBhbHJlYWR5IGhhbmRsZWRgKTtcclxuICAgIH1cclxuICAgIHRoaXMubm90aWZpY2F0aW9uSGFuZGxlcnMuc2V0KG1ldGhvZCwgaGFuZGxlcik7XHJcblxyXG4gICAgLy8gVW5zdWJzY3JpYmUgY2FsbGJhY2tcclxuICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgIHRoaXMubm90aWZpY2F0aW9uSGFuZGxlcnMuZGVsZXRlKG1ldGhvZCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcmVxdWVzdChtZXRob2Q6IHN0cmluZywgcGFyYW1zPzogSnNvblJwY1BhcmFtc1NjaGVtYSk6IFByb21pc2U8YW55PiB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICBzdXBlci5yZXF1ZXN0KG1ldGhvZCwgcGFyYW1zKVxyXG4gICAgICAgIC50aGVuKHJlc29sdmUpXHJcbiAgICAgICAgLmNhdGNoKChlOiBKc29uUnBjRXJyb3IpID0+IHtcclxuICAgICAgICAgIHJlamVjdCh3cmFwRXJyb3IoZSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBkZXN0cm95KGVycm9yPzogRXJyb3IpIHtcclxuICAgIHRoaXMuZW1pdCgnY2xvc2UnKTtcclxuICAgIHRoaXMuZW1pdCgnZW5kJyk7XHJcbiAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgdGhpcy5lbWl0KCdlcnJvcicsIGVycm9yKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19